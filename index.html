<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator ocen – mgr Agnieszka Makuła-Broda</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#38bdf8; --card:#0b1220; --border:#1f2937; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:
      radial-gradient(1200px 800px at 20% -10%, rgba(56,189,248,.15), transparent),
      radial-gradient(1000px 700px at 120% 10%, rgba(34,197,94,.12), transparent),
      var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 28px auto 80px; padding: 0 16px; }
    .title { font-size: clamp(24px, 3vw, 34px); font-weight: 800; letter-spacing: .2px; }
    .subtitle { color: var(--muted); margin-top: 6px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); margin-top: 24px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); border: 1px solid var(--border); border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    .card h3 { margin: 0 0 10px; font-size: 16px; letter-spacing: .3px; color: #cbd5e1; }
    .col-4 { grid-column: span 4; } .col-8 { grid-column: span 8; } .col-6 { grid-column: span 6; } .col-12 { grid-column: span 12; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="number"], input[type="text"], select { width: 100%; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; outline: none; transition: border-color .15s ease, box-shadow .15s ease; font-size: 14px; }
    input:focus, select:focus { border-color: var(--accent-2); box-shadow: 0 0 0 3px rgba(56,189,248,.15); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .small { font-size: 12px; color: var(--muted); }
    .btn { background: linear-gradient(180deg, rgba(56,189,248,.15), rgba(56,189,248,.08)); color: #e6f9ff; border: 1px solid rgba(56,189,248,.5); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 700; letter-spacing: .3px; }
    .btn:hover { filter: brightness(1.1); }
    .btn.secondary { background: transparent; border-color: var(--border); color: #e5e7eb; }
    .install { background: linear-gradient(180deg, rgba(34,197,94,.15), rgba(34,197,94,.08)); border: 1px solid rgba(34,197,94,.5); }
    .kpi { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 8px; }
    .kpi .box { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid var(--border); border-radius: 16px; padding: 16px; text-align: center; }
    .kpi .val { font-size: clamp(20px, 2.4vw, 28px); font-weight: 900; }
    .kpi .lbl { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .thresholds { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .thr-head, .thr-item { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 8px; padding: 10px 12px; align-items: center; }
    .thr-head { background: rgba(255,255,255,.03); font-size: 12px; color: var(--muted); }
    .thr-item:nth-child(even) { background: rgba(255,255,255,.02); }
    .input-wrap { position: relative; }
    .spinner { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border: 2px solid rgba(148,163,184,.35); border-top-color: rgba(56,189,248,.9); border-radius: 999px; display: none; }
    .spinner.spin { display: inline-block; animation: spin .9s linear; }
    @keyframes spin { from{ transform: translateY(-50%) rotate(0deg);} to{ transform: translateY(-50%) rotate(360deg);} }
    @media (max-width: 980px) { .col-4, .col-6, .col-8 { grid-column: span 12; } .kpi { grid-template-columns: 1fr; } .thr-head, .thr-item { grid-template-columns: 70px 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Kalkulator ocen – mgr Agnieszka Makuła-Broda</div>
    <div class="subtitle">Auto‑przeliczanie, <b>Enter</b>, <b>Ctrl+Enter</b> oraz PWA (instalacja na telefonie).</div>

    <div class="grid">
      <div class="card col-4">
        <h3>Ustawienia ogólne</h3>
        <div class="row">
          <div>
            <label>Maks. liczba punktów</label>
            <input id="maxPts" type="number" min="1" step="1" value="20" />
          </div>
          <div>
            <label>Skala ocen</label>
            <select id="scale">
              <option value="6">1–6</option>
              <option value="5">1–5</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Rodzaj progów</label>
            <select id="mode">
              <option value="percent">progi procentowe</option>
              <option value="points">progi punktowe</option>
            </select>
          </div>
          <div>
            <label>Zaokrąglanie wyniku</label>
            <select id="rounding">
              <option value="1">do 0,1 pp</option>
              <option value="0">do 1 pp</option>
              <option value="2">do 0,01 pp</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px;">
          <label><input id="autoCalc" type="checkbox" style="transform: translateY(1px); margin-right:8px;"> Auto‑przeliczanie na żywo</label>
          <div class="small">Gdy włączone, wynik liczy się przy każdym wpisanym znaku.</div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnSave">Zapisz ustawienia</button>
          <button class="btn secondary" id="btnReset">Przywróć domyślne</button>
          <button class="btn install" id="btnInstall" title="Zainstaluj jako aplikację">Zainstaluj aplikację</button>
        </div>
      </div>

      <div class="card col-8">
        <h3>Progi dla ocen</h3>
        <div class="small" style="margin-bottom:8px;">Ustal minimalny <span id="unitLbl">%</span> dla danej oceny. Zakresy liczone są „od progu w górę”.</div>
        <div class="thresholds" id="thresholds">
          <div class="thr-head"><div>Ocena</div><div>Min. próg</div><div>Nazwa słowna</div></div>
        </div>
      </div>

      <div class="card col-6">
        <h3>Wynik ucznia</h3>
        <div class="row">
          <div>
            <label>Zdobyte punkty</label>
            <div class="input-wrap"><input id="gotPts" type="number" min="0" step="0.5" value="15" />
              <span id="calcSpin" class="spinner" aria-hidden="true"></span>
            </div>
          </div>
          <div>
            <label>Oblicz</label>
            <button class="btn" id="btnCalc" style="width:100%">Policz ocenę</button>
          </div>
        </div>
        <div class="kpi">
          <div class="box"><div class="val" id="kpiPct">—</div><div class="lbl">Procent wyniku</div></div>
          <div class="box"><div class="val" id="kpiGradeNum">—</div><div class="lbl">Ocena (liczbowa)</div></div>
          <div class="box"><div class="val" id="kpiGradeText">—</div><div class="lbl">Ocena (słownie)</div></div>
        </div>
      </div>

      <div class="card col-6">
        <h3>Szybka tabela wyników</h3>
        <div class="small">Wpisuj punkty po przecinku, np. <code>12.5</code>. Tabela aktualizuje się automatycznie.</div>
        <div id="quickList" style="margin-top:10px; display:grid; gap:8px;"></div>
      </div>
    </div>
  </div>

  <script>
    const els = {
      maxPts: document.getElementById('maxPts'),
      scale: document.getElementById('scale'),
      mode: document.getElementById('mode'),
      rounding: document.getElementById('rounding'),
      gotPts: document.getElementById('gotPts'),
      btnCalc: document.getElementById('btnCalc'),
      btnSave: document.getElementById('btnSave'),
      btnReset: document.getElementById('btnReset'),
      btnInstall: document.getElementById('btnInstall'),
      autoCalc: document.getElementById('autoCalc'),
      thresholds: document.getElementById('thresholds'),
      unitLbl: document.getElementById('unitLbl'),
      kpiPct: document.getElementById('kpiPct'),
      kpiGradeNum: document.getElementById('kpiGradeNum'),
      kpiGradeText: document.getElementById('kpiGradeText'),
      quickList: document.getElementById('quickList'),
    };

    const STORAGE_KEY = 'gradeCalc_settings_v5';
    const DEFAULTS = {
      maxPts: 20, scale: 6, mode: 'percent', rounding: 1, autoCalc: false,
      names6: {6:'celujący',5:'bardzo dobry',4:'dobry',3:'dostateczny',2:'dopuszczający',1:'niedostateczny'},
      names5: {5:'bardzo dobry',4:'dobry',3:'dostateczny',2:'dopuszczający',1:'niedostateczny'},
      thr6_percent: {6:95,5:85,4:70,3:50,2:30,1:0},
      thr6_points:  {6:19,5:17,4:14,3:10,2:6, 1:0},
      thr5_percent: {5:90,4:75,3:55,2:35,1:0},
      thr5_points:  {5:18,4:15,3:11,2:7, 1:0},
    };
    function loadState(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch { return null; } }
    function saveState(obj){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch {} }

    function defaultThr(scale, mode){ return (scale===6) ? (mode==='percent'? {...DEFAULTS.thr6_percent}: {...DEFAULTS.thr6_points}) : (mode==='percent'? {...DEFAULTS.thr5_percent}: {...DEFAULTS.thr5_points}); }
    function defaultNames(scale){ return (scale===6)? {...DEFAULTS.names6}: {...DEFAULTS.names5}; }

    function renderThresholdRows(scale, mode, thr, names){
      const container = els.thresholds;
      [...container.querySelectorAll('.thr-item')].forEach(n=>n.remove());
      const grades = scale===6? [6,5,4,3,2,1] : [5,4,3,2,1];
      grades.forEach(g=>{
        const row = document.createElement('div');
        row.className = 'thr-item';
        const thrVal = (thr && thr[g] != null)? thr[g] : defaultThr(scale, mode)[g];
        const nameVal = (names && names[g])? names[g] : defaultNames(scale)[g];
        row.innerHTML = `
          <div><b>${g}</b></div>
          <div><input type="number" step="0.1" min="0" id="thr_${g}" value="${thrVal}" /></div>
          <div><input type="text" id="name_${g}" value="${nameVal}" /></div>`;
        container.appendChild(row);
      });
    }

    function readThrInputs(){
      const scale = +els.scale.value; const grades = scale===6? [6,5,4,3,2,1] : [5,4,3,2,1]; const out={};
      grades.forEach(g=>{ const el=document.getElementById('thr_'+g); if(el&&el.value!==undefined){ const v=parseFloat(el.value); out[g]=Number.isFinite(v)?v:undefined; } else { out[g]=undefined; } });
      return out;
    }
    function readNameInputs(){
      const scale = +els.scale.value; const grades = scale===6? [6,5,4,3,2,1] : [5,4,3,2,1]; const out={};
      grades.forEach(g=>{ const el=document.getElementById('name_'+g); if(el&&typeof el.value==='string'){ const v=el.value.trim(); out[g]=v||defaultNames(scale)[g]; } else { out[g]=defaultNames(scale)[g]; } });
      return out;
    }

    function computePercentage(got, max){ if(max<=0) return 0; let pct=(got/max)*100; if(pct<0) pct=0; if(pct>100) pct=100; return pct; }
    function pickGrade({gotPts, maxPts, scale, mode, thr, names}){
      const pct = computePercentage(gotPts, maxPts);
      const grades = scale===6? [6,5,4,3,2,1] : [5,4,3,2,1];
      const thrPercent = {};
      grades.forEach(g=>{ const base=defaultThr(scale, mode)[g]; const t = (thr && thr[g] != null)? thr[g] : base; thrPercent[g] = (mode==='points')? (maxPts>0? (t/maxPts)*100 : 0) : t; });
      const ordered = [...grades].sort((a,b)=> (thrPercent[b]-thrPercent[a]) || (b-a));
      let chosen = ordered.find(g => pct >= thrPercent[g]); if(chosen==null) chosen = ordered[ordered.length-1];
      return { pct, gradeNum: chosen, gradeText: (names && names[chosen])? names[chosen] : defaultNames(scale)[chosen] };
    }
    function formatPct(p, decimals){ return p.toFixed(decimals).replace('.', ',') + ' %'; }

    function calcOnce(){
      const maxPts = +els.maxPts.value || 0; const gotPts = +els.gotPts.value || 0; const scale = +els.scale.value; const mode = els.mode.value; const rounding = +els.rounding.value; const thr = readThrInputs(); const names = readNameInputs();
      const res = pickGrade({gotPts, maxPts, scale, mode, thr, names});
      els.kpiPct.textContent = formatPct(res.pct, rounding);
      els.kpiGradeNum.textContent = String(res.gradeNum);
      els.kpiGradeText.textContent = res.gradeText;
      refreshQuickList();
    }

    function refreshQuickList(){
      const maxPts = +els.maxPts.value || 0; const scale = +els.scale.value; const mode = els.mode.value; const thr = readThrInputs(); const names = readNameInputs(); const rounding = +els.rounding.value;
      const list=[]; for(let p=0; p<=maxPts; p++){ const r=pickGrade({gotPts:p, maxPts, scale, mode, thr, names}); list.push({p, pct: r.pct.toFixed(rounding).replace('.',','), gradeNum: r.gradeNum, gradeText: r.gradeText}); }
      els.quickList.innerHTML=''; list.forEach(row=>{ const div=document.createElement('div'); div.style.border='1px solid var(--border)'; div.style.borderRadius='12px'; div.style.padding='8px 12px'; div.style.display='grid'; div.style.gridTemplateColumns='1fr 1fr 1fr 2fr'; div.style.gap='8px'; div.innerHTML = `<div><span class="small">Punkty</span><br><b>${row.p}</b></div><div><span class="small">Procent</span><br><b>${row.pct} %</b></div><div><span class="small">Ocena</span><br><b>${row.gradeNum}</b></div><div><span class="small">Słownie</span><br><b>${row.gradeText}</b></div>`; els.quickList.appendChild(div); });
    }

    function updateUnitLabel(){ els.unitLbl.textContent = (els.mode.value==='percent')? '%': 'pkt'; }

    function applyState(st){
      els.maxPts.value = st.maxPts; els.scale.value = st.scale; els.mode.value = st.mode; els.rounding.value = st.rounding; els.autoCalc.checked = !!st.autoCalc;
      renderThresholdRows(st.scale, st.mode, st.thr, st.names);
      updateUnitLabel();
      bindAutoCalc();
      calcOnce();
    }

    function init(forceDefaults=false){
      const st = (!forceDefaults && loadState()) || { maxPts: DEFAULTS.maxPts, scale: DEFAULTS.scale, mode: DEFAULTS.mode, rounding: DEFAULTS.rounding, autoCalc: DEFAULTS.autoCalc, thr: defaultThr(DEFAULTS.scale, DEFAULTS.mode), names: defaultNames(DEFAULTS.scale) };
      applyState(st);
    }

    function readState(){ return { maxPts:+els.maxPts.value, scale:+els.scale.value, mode:els.mode.value, rounding:+els.rounding.value, autoCalc: !!els.autoCalc.checked, thr: readThrInputs(), names: readNameInputs() }; }

    // ZAPIS/RESET
    els.btnSave.addEventListener('click', ()=>{ saveState(readState()); flash(els.btnSave); });
    els.btnReset.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); init(true); });

    // PRZELICZANIE
    els.gotPts.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); calcOnce(); }});
    document.addEventListener('keydown',(e)=>{ if(e.ctrlKey && e.key==='Enter'){ e.preventDefault(); calcOnce(); }});
    els.btnCalc.addEventListener('click', calcOnce);

    // Auto-calc + spinner
    const spinEl = document.getElementById('calcSpin'); let spinTimer=null; function blipSpinner(){ if(!spinEl) return; spinEl.classList.remove('spin'); void spinEl.offsetWidth; spinEl.classList.add('spin'); clearTimeout(spinTimer); spinTimer=setTimeout(()=> spinEl.classList.remove('spin'), 1000); }
    function onInputAuto(){ calcOnce(); blipSpinner(); }
    function bindAutoCalc(){ try{ els.gotPts.removeEventListener('input', onInputAuto);}catch{} if(els.autoCalc && els.autoCalc.checked){ els.gotPts.addEventListener('input', onInputAuto);} }

    // Zmiany ustawień: zwykłe
    ['maxPts','mode','rounding'].forEach(id=>{ els[id].addEventListener('change', ()=>{ const thr=readThrInputs(); const names=readNameInputs(); renderThresholdRows(+els.scale.value, els.mode.value, thr, names); updateUnitLabel(); refreshQuickList(); saveState(readState()); });});
    // Przy zmianie skali: reset progów do domyślnych, zachowaj nazwy
    els.scale.addEventListener('change', ()=>{ const names=readNameInputs(); const thr=defaultThr(+els.scale.value, els.mode.value); renderThresholdRows(+els.scale.value, els.mode.value, thr, names); updateUnitLabel(); refreshQuickList(); saveState(readState()); });
    els.autoCalc.addEventListener('change', ()=>{ bindAutoCalc(); saveState(readState()); });

    function flash(el){ el.style.boxShadow='0 0 0 6px rgba(56,189,248,.2)'; setTimeout(()=> el.style.boxShadow='', 350); }

    // PWA (rejestracja SW)
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
    let deferred; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred=e; els.btnInstall.disabled=false; });
    els.btnInstall.addEventListener('click', async()=>{ if(!deferred) return; deferred.prompt(); try{ await deferred.userChoice; }catch{} deferred=null; els.btnInstall.disabled=true; });

    init();
  </script>
</body>
</html>
